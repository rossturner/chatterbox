<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox TTS Server</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #3730a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .emotion-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .emotion-card:hover {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }
        
        .emotion-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .emotion-name {
            font-size: 1.25em;
            font-weight: 700;
            color: #1f2937;
        }
        
        .emotion-character {
            color: #6b7280;
            font-style: italic;
        }
        
        .emotion-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .exaggeration-control {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .exaggeration-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .exaggeration-value {
            font-weight: 600;
            color: #4f46e5;
            margin-left: 10px;
        }
        
        .exaggeration-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-save {
            background: #10b981;
        }
        
        .btn-save:hover {
            background: #047857;
        }
        
        .btn-cancel {
            background: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .voice-samples {
            margin-top: 15px;
        }
        
        .voice-sample {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .generation-form {
            background: #f9fafb;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .generation-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #047857;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready {
            background: #10b981;
        }
        
        .status-loading {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }
        
        .status-error {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #4f46e5;
            background: #f8fafc;
        }
        
        .upload-zone.dragover {
            border-color: #4f46e5;
            background: #ede9fe;
        }
        
        .server-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #4f46e5;
        }
        
        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close:hover {
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Chatterbox TTS Server</h1>
            <p>High-performance Text-to-Speech with Voice Cloning & Emotion Control</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('generate')">Generate</button>
            <button class="nav-tab" onclick="switchTab('emotions')">Manage Emotions</button>
            <button class="nav-tab" onclick="switchTab('status')">Server Status</button>
        </div>
        
        <!-- Generate Tab -->
        <div id="generate-tab" class="tab-content active">
            <div class="generation-form">
                <h2>Generate Speech</h2>
                <div id="generation-alerts"></div>
                
                <div class="form-group">
                    <label for="emotion-select">Emotion/Character:</label>
                    <select id="emotion-select" required>
                        <option value="">Select an emotion...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="text-input">Text to synthesize:</label>
                    <textarea id="text-input" rows="4" placeholder="Enter the text you want to convert to speech..." required></textarea>
                </div>
                
                <div class="generation-settings">
                    <div class="form-group">
                        <label for="temperature">Temperature:</label>
                        <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.8">
                        <span id="temperature-value">0.8</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="repetition-penalty">Repetition Penalty:</label>
                        <input type="range" id="repetition-penalty" min="1.0" max="2.0" step="0.1" value="1.2">
                        <span id="repetition-penalty-value">1.2</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="cfg-weight">CFG Weight:</label>
                        <input type="range" id="cfg-weight" min="0.0" max="1.0" step="0.1" value="0.5">
                        <span id="cfg-weight-value">0.5</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="seed">Seed (optional):</label>
                        <input type="number" id="seed" placeholder="Random seed">
                    </div>
                </div>
                
                <button id="generate-btn" class="btn" onclick="generateSpeech()">
                    üéµ Generate Speech
                </button>
            </div>
            
            <div id="audio-output" class="hidden">
                <h3>Generated Audio</h3>
                <audio id="audio-player" controls style="width: 100%; margin: 20px 0;"></audio>
                <div id="generation-info"></div>
            </div>
        </div>
        
        <!-- Emotions Tab -->
        <div id="emotions-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Emotion Profiles</h2>
                <button class="btn" onclick="showCreateEmotionModal()">
                    ‚ûï Add New Emotion
                </button>
            </div>
            
            <div id="emotion-alerts"></div>
            <div id="emotions-list">
                <div class="loading"></div>
            </div>
        </div>
        
        <!-- Status Tab -->
        <div id="status-tab" class="tab-content">
            <h2>Server Status</h2>
            <div id="server-stats" class="server-stats">
                <div class="loading"></div>
            </div>
        </div>
    </div>
    
    <!-- Create Emotion Modal -->
    <div id="create-emotion-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-emotion-modal')">&times;</span>
            <h2>Create New Emotion</h2>
            <form id="create-emotion-form">
                <div class="form-group">
                    <label for="emotion-name">Emotion Name:</label>
                    <input type="text" id="emotion-name" required placeholder="e.g., Happy, Sad, Angry">
                </div>
                
                <div class="form-group">
                    <label for="character-name">Character Name:</label>
                    <input type="text" id="character-name" required placeholder="e.g., Nicole, Alice, Bob">
                </div>
                
                <div class="form-group">
                    <label for="exaggeration">Exaggeration Level:</label>
                    <input type="range" id="exaggeration" min="0.0" max="1.0" step="0.1" value="0.5">
                    <span id="exaggeration-value">0.5</span>
                </div>
                
                <div class="form-group">
                    <label for="emotion-description">Description (optional):</label>
                    <textarea id="emotion-description" rows="3" placeholder="Describe this emotion..."></textarea>
                </div>
                
                <button type="submit" class="btn">Create Emotion</button>
            </form>
        </div>
    </div>
    
    <!-- Voice Upload Modal -->
    <div id="voice-upload-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('voice-upload-modal')">&times;</span>
            <h2>Upload Voice Sample</h2>
            <div id="upload-emotion-name"></div>
            
            <div class="upload-zone" id="upload-zone">
                <div>üìÅ Drop audio files here or click to browse</div>
                <div style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                    Supported formats: WAV, MP3, FLAC, OGG (Max 50MB)
                </div>
                <input type="file" id="voice-file" accept=".wav,.mp3,.flac,.ogg" style="display: none;">
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="voice-description">Description (optional):</label>
                <input type="text" id="voice-description" placeholder="Describe this voice sample...">
            </div>
            
            <button id="upload-voice-btn" class="btn" onclick="uploadVoice()" disabled>
                Upload Voice Sample
            </button>
        </div>
    </div>

    <script>
        let currentEmotionId = null;
        let emotions = [];
        let selectedFile = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadEmotions();
            loadServerStatus();
            setupEventListeners();
            setupSliders();
        });
        
        function setupEventListeners() {
            // Upload zone events
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('voice-file');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('drop', handleDrop);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Form submissions
            document.getElementById('create-emotion-form').addEventListener('submit', createEmotion);
        }
        
        function setupSliders() {
            // Update slider values
            const sliders = ['temperature', 'repetition-penalty', 'cfg-weight', 'exaggeration'];
            sliders.forEach(slider => {
                const element = document.getElementById(slider);
                const valueElement = document.getElementById(slider + '-value');
                if (element && valueElement) {
                    element.addEventListener('input', function() {
                        valueElement.textContent = this.value;
                    });
                }
            });
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data if needed
            if (tabName === 'emotions') {
                loadEmotions();
            } else if (tabName === 'status') {
                loadServerStatus();
            }
        }
        
        async function loadEmotions() {
            try {
                const response = await fetch('/emotions');
                const data = await response.json();
                emotions = data.emotions;
                
                renderEmotionsList(emotions);
                updateEmotionSelect(emotions);
            } catch (error) {
                showAlert('emotion-alerts', 'Error loading emotions: ' + error.message, 'error');
            }
        }
        
        function renderEmotionsList(emotions) {
            const container = document.getElementById('emotions-list');
            
            if (emotions.length === 0) {
                container.innerHTML = '<p>No emotion profiles found. Create your first emotion to get started!</p>';
                return;
            }
            
            container.innerHTML = emotions.map(emotion => `
                <div class="emotion-card">
                    <div class="emotion-header">
                        <div>
                            <div class="emotion-name">
                                <span class="status-indicator ${getEmotionStatus(emotion.id)}"></span>
                                ${emotion.name}
                            </div>
                            <div class="emotion-character">Character: ${emotion.character}</div>
                        </div>
                    </div>
                    <div>
                        <strong>Voice Samples:</strong> ${emotion.voice_samples.length}<br>
                        ${emotion.description ? `<strong>Description:</strong> ${emotion.description}<br>` : ''}
                        <strong>Created:</strong> ${new Date(emotion.created_at).toLocaleDateString()}
                    </div>
                    
                    <div class="exaggeration-control">
                        <label for="exaggeration-${emotion.id}">
                            <strong>Exaggeration Level:</strong>
                            <span class="exaggeration-value" id="exaggeration-value-${emotion.id}">${emotion.exaggeration}</span>
                        </label>
                        <input type="range" 
                               id="exaggeration-${emotion.id}" 
                               class="exaggeration-slider" 
                               min="0.0" 
                               max="1.0" 
                               step="0.1" 
                               value="${emotion.exaggeration}"
                               data-original="${emotion.exaggeration}"
                               onchange="onExaggerationChange('${emotion.id}')"
                               oninput="updateExaggerationDisplay('${emotion.id}')">
                        <div class="exaggeration-actions hidden" id="exaggeration-actions-${emotion.id}">
                            <button class="btn btn-save" onclick="saveExaggerationChange('${emotion.id}')">
                                üíæ Save Changes
                            </button>
                            <button class="btn btn-cancel" onclick="cancelExaggerationChange('${emotion.id}')">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div class="voice-samples">
                        ${emotion.voice_samples.map(sample => `
                            <div class="voice-sample">
                                <span>üéµ ${sample}</span>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="removeVoiceSample('${emotion.id}', '${sample}')">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="emotion-actions">
                        <button class="btn" onclick="testEmotion('${emotion.id}')">üé§ Test</button>
                        <button class="btn btn-secondary" onclick="showVoiceUploadModal('${emotion.id}', '${emotion.name}')">üìÅ Add Voice</button>
                        <button class="btn btn-danger" onclick="deleteEmotion('${emotion.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateEmotionSelect(emotions) {
            const select = document.getElementById('emotion-select');
            select.innerHTML = '<option value="">Select an emotion...</option>' +
                emotions.map(emotion => 
                    `<option value="${emotion.id}">${emotion.character} - ${emotion.name}</option>`
                ).join('');
        }
        
        function getEmotionStatus(emotionId) {
            // This would need to be determined by checking if the emotion has conditionals ready
            return 'status-ready'; // Simplified for now
        }
        
        async function generateSpeech() {
            const emotionId = document.getElementById('emotion-select').value;
            const text = document.getElementById('text-input').value;
            
            if (!emotionId || !text) {
                showAlert('generation-alerts', 'Please select an emotion and enter text', 'error');
                return;
            }
            
            const btn = document.getElementById('generate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        emotion: emotionId,
                        temperature: parseFloat(document.getElementById('temperature').value),
                        repetition_penalty: parseFloat(document.getElementById('repetition-penalty').value),
                        cfg_weight: parseFloat(document.getElementById('cfg-weight').value),
                        seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null
                    })
                });
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    const audioOutput = document.getElementById('audio-output');
                    const audioPlayer = document.getElementById('audio-player');
                    const generationInfo = document.getElementById('generation-info');
                    
                    console.log('Audio output element:', audioOutput);
                    console.log('Audio player element:', audioPlayer);
                    
                    // Handle both base64 audio data and file URLs
                    if (data.audio_data) {
                        // Base64 audio data - create data URL (simpler approach)
                        console.log('Base64 data length:', data.audio_data.length);
                        console.log('Base64 data start:', data.audio_data.substring(0, 50));
                        const dataUrl = `data:audio/wav;base64,${data.audio_data}`;
                        audioPlayer.src = dataUrl;
                        console.log('Set audio source to base64 data URL');
                        
                        // Listen for load events
                        audioPlayer.onloadeddata = () => console.log('Audio data loaded successfully');
                        audioPlayer.onerror = (e) => console.log('Audio load error:', e);
                        audioPlayer.oncanplay = () => console.log('Audio can play');
                    } else if (data.audio_url) {
                        // File URL (fallback)
                        audioPlayer.src = data.audio_url;
                        console.log('Set audio source to file URL:', data.audio_url);
                    } else {
                        console.log('No audio data or URL in response');
                    }
                    
                    audioOutput.classList.remove('hidden');
                    
                    // Auto-play the generated audio
                    audioPlayer.play().catch(error => {
                        console.log('Auto-play failed:', error);
                        showAlert('generation-alerts', 'Speech generated successfully! Click play to listen.', 'success');
                    });
                    
                    generationInfo.innerHTML = `
                        <div><strong>Duration:</strong> ${data.duration_seconds.toFixed(2)}s</div>
                        <div><strong>Generation Time:</strong> ${data.generation_time_seconds.toFixed(2)}s</div>
                        <div><strong>Real-time Factor:</strong> ${data.metadata.rtf.toFixed(2)}x</div>
                        <div><strong>Device:</strong> ${data.metadata.device}</div>
                    `;
                    
                    showAlert('generation-alerts', 'Speech generated and playing!', 'success');
                } else {
                    showAlert('generation-alerts', 'Generation failed: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('generation-alerts', 'Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function testEmotion(emotionId) {
            try {
                const response = await fetch(`/emotions/${emotionId}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emotion_id: emotionId,
                        text: "Hello, this is a test of the emotion profile."
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const audio = new Audio(data.audio_url);
                    audio.play();
                    showAlert('emotion-alerts', 'Test audio generated and playing!', 'success');
                } else {
                    showAlert('emotion-alerts', 'Test failed: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error: ' + error.message, 'error');
            }
        }
        
        async function createEmotion(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('emotion-name').value,
                character: document.getElementById('character-name').value,
                exaggeration: parseFloat(document.getElementById('exaggeration').value),
                description: document.getElementById('emotion-description').value || null
            };
            
            try {
                const response = await fetch('/emotions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('emotion-alerts', 'Emotion created successfully!', 'success');
                    closeModal('create-emotion-modal');
                    document.getElementById('create-emotion-form').reset();
                    loadEmotions();
                } else {
                    showAlert('emotion-alerts', 'Error creating emotion: ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error: ' + error.message, 'error');
            }
        }
        
        async function deleteEmotion(emotionId) {
            if (!confirm('Are you sure you want to delete this emotion? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/emotions/${emotionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('emotion-alerts', 'Emotion deleted successfully!', 'success');
                    loadEmotions();
                } else {
                    const data = await response.json();
                    showAlert('emotion-alerts', 'Error deleting emotion: ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error: ' + error.message, 'error');
            }
        }
        
        function showCreateEmotionModal() {
            document.getElementById('create-emotion-modal').style.display = 'block';
        }
        
        function showVoiceUploadModal(emotionId, emotionName) {
            currentEmotionId = emotionId;
            document.getElementById('upload-emotion-name').innerHTML = `<h3>Adding voice sample for: ${emotionName}</h3>`;
            document.getElementById('voice-upload-modal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'voice-upload-modal') {
                document.getElementById('voice-file').value = '';
                document.getElementById('voice-description').value = '';
                document.getElementById('upload-voice-btn').disabled = true;
                selectedFile = null;
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                const uploadBtn = document.getElementById('upload-voice-btn');
                uploadBtn.disabled = false;
                document.getElementById('upload-zone').innerHTML = `
                    <div>üìÅ Selected: ${selectedFile.name}</div>
                    <div style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                        Click upload button to add this voice sample
                    </div>
                    <input type="file" id="voice-file" accept=".wav,.mp3,.flac,.ogg" style="display: none;">
                `;
            }
        }
        
        function handleFileSelect() {
            const fileInput = document.getElementById('voice-file');
            const uploadBtn = document.getElementById('upload-voice-btn');
            
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                uploadBtn.disabled = false;
                document.getElementById('upload-zone').innerHTML = `
                    <div>üìÅ Selected: ${selectedFile.name}</div>
                    <div style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                        Click upload button to add this voice sample
                    </div>
                    <input type="file" id="voice-file" accept=".wav,.mp3,.flac,.ogg" style="display: none;">
                `;
            }
        }
        
        async function uploadVoice() {
            const description = document.getElementById('voice-description').value;
            
            if (!selectedFile || !currentEmotionId) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            if (description) {
                formData.append('description', description);
            }
            
            const btn = document.getElementById('upload-voice-btn');
            btn.innerHTML = '<span class="loading"></span> Uploading...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`/emotions/${currentEmotionId}/voices`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('emotion-alerts', 'Voice sample uploaded successfully!', 'success');
                    closeModal('voice-upload-modal');
                    loadEmotions();
                } else {
                    showAlert('emotion-alerts', 'Upload failed: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = 'Upload Voice Sample';
                btn.disabled = false;
            }
        }
        
        async function loadServerStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('server-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${data.status}</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.emotions_loaded}</div>
                        <div class="stat-label">Emotions Loaded</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.memory_usage_mb.toFixed(1)}MB</div>
                        <div class="stat-label">Memory Usage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.device}</div>
                        <div class="stat-label">Device</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.floor(data.uptime_seconds / 60)}m</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('server-stats').innerHTML = '<p>Error loading server status</p>';
            }
        }
        
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function updateExaggerationDisplay(emotionId) {
            const slider = document.getElementById(`exaggeration-${emotionId}`);
            const valueDisplay = document.getElementById(`exaggeration-value-${emotionId}`);
            valueDisplay.textContent = slider.value;
        }
        
        function onExaggerationChange(emotionId) {
            const slider = document.getElementById(`exaggeration-${emotionId}`);
            const original = parseFloat(slider.dataset.original);
            const current = parseFloat(slider.value);
            const actions = document.getElementById(`exaggeration-actions-${emotionId}`);
            
            if (Math.abs(current - original) > 0.05) { // Show save/cancel if changed by more than 0.05
                actions.classList.remove('hidden');
            } else {
                actions.classList.add('hidden');
            }
        }
        
        async function saveExaggerationChange(emotionId) {
            const slider = document.getElementById(`exaggeration-${emotionId}`);
            const actions = document.getElementById(`exaggeration-actions-${emotionId}`);
            const newValue = parseFloat(slider.value);
            
            try {
                // Show loading state
                const saveBtn = actions.querySelector('.btn-save');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="loading"></span> Saving...';
                saveBtn.disabled = true;
                
                const response = await fetch(`/emotions/${emotionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exaggeration: newValue
                    })
                });
                
                if (response.ok) {
                    // Update the original value and hide actions
                    slider.dataset.original = newValue.toString();
                    actions.classList.add('hidden');
                    
                    // Update the emotion in our local array
                    const emotion = emotions.find(e => e.id === emotionId);
                    if (emotion) {
                        emotion.exaggeration = newValue;
                    }
                    
                    showAlert('emotion-alerts', `Exaggeration updated to ${newValue}! Voice conditionals are being recomputed in the background.`, 'success');
                } else {
                    const errorData = await response.json();
                    showAlert('emotion-alerts', 'Failed to update exaggeration: ' + errorData.detail, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error updating exaggeration: ' + error.message, 'error');
            } finally {
                // Restore button state
                const saveBtn = actions.querySelector('.btn-save');
                saveBtn.innerHTML = 'üíæ Save Changes';
                saveBtn.disabled = false;
            }
        }
        
        function cancelExaggerationChange(emotionId) {
            const slider = document.getElementById(`exaggeration-${emotionId}`);
            const valueDisplay = document.getElementById(`exaggeration-value-${emotionId}`);
            const actions = document.getElementById(`exaggeration-actions-${emotionId}`);
            const original = parseFloat(slider.dataset.original);
            
            // Reset to original value
            slider.value = original;
            valueDisplay.textContent = original;
            actions.classList.add('hidden');
        }
        
        async function removeVoiceSample(emotionId, voiceFilename) {
            if (!confirm(`Are you sure you want to remove the voice sample "${voiceFilename}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/emotions/${emotionId}/voices/remove?voice_filename=${encodeURIComponent(voiceFilename)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('emotion-alerts', 'Voice sample removed successfully!', 'success');
                    loadEmotions(); // Refresh the emotion list
                } else {
                    const errorData = await response.json();
                    showAlert('emotion-alerts', 'Failed to remove voice sample: ' + errorData.detail, 'error');
                }
            } catch (error) {
                showAlert('emotion-alerts', 'Error removing voice sample: ' + error.message, 'error');
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>